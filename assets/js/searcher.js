Searcher=function(){this.config={minChunkSize:3,maxChunkSize:8,weight:{name:1.0,description:0.2,exDescription:0.1,}};this.wantedProps=Object.keys(this.config.weight);this.dictionary;this.maxCount;this.avgCount;this.results=[];};Searcher.prototype.setDictionary=function(dictionary){this.dictionary=dictionary;};Searcher.prototype.clearDictionary=function(){this.dictionary=undefined;};Searcher.prototype.clearResults=function(){this.results=[];};Searcher.prototype.setData=function(data){$.map(data,function(item){item.description='';item.exDescription='';$.each(item.invocations,function(_,inv){item.description+=inv.description+' ';item.exDescription+=inv.exDescription+' ';});return item;});this.data=data;if(this.dictionary===undefined){this.makeDictionary();}};Searcher.prototype.makeDictionary=function(){var dict={};var maxCount={};var wantedProps=this.wantedProps;var totalWords=0,uniqueWords=0;for(var i=wantedProps.length- 1;i>=0;i--){dict[wantedProps[i]]={};maxCount[wantedProps[i]]=0;}
var data=this.data,item,wantedProp,words,word;for(var i=data.length- 1;i>=0;i--){item=data[i];for(var j=wantedProps.length- 1;j>=0;j--){wantedProp=wantedProps[j];if(item[wantedProp]===undefined){continue;}
words=this.normalizeString(item[wantedProp]).split(' ');for(var k=words.length- 1;k>=0;k--){word=words[k];if(word.length<this.config.minChunkSize){continue;}
if(dict[wantedProp][word]===undefined){dict[wantedProp][word]={count:0,keys:[]};uniqueWords++;}
if(wantedProp!=='name'){dict[wantedProp][word].count+=1;}else{dict[wantedProp][word].count=1;}
totalWords++;maxCount[wantedProp]=Math.max(maxCount[wantedProp],dict[wantedProp][word].count);if(dict[wantedProp][word].keys.indexOf(i)===-1){dict[wantedProp][word].keys.push(i);}}}}
this.avgCount=totalWords/uniqueWords;maxCount.name=1;this.dictionary=dict;this.maxCount=maxCount;};Searcher.prototype.search=function(query){this.clearResults();var queries=this.fuzzySplit(this.normalizeString(query));for(var i=queries.length- 1;i>=0;i--){this.find(queries[i]);}
this.sortResults();this.doResults();return this.results;};Searcher.prototype.doResults=function(){var _this=this;this.results.splice(15,9999);$.map(this.results,function(value){$.extend(value,_this.data[value.key]);return value;});};Searcher.prototype.find=function(query){var _this=this;for(var i=this.wantedProps.length- 1;i>=0;i--){var wantedProp=this.wantedProps[i];weight=this.config.weight[wantedProp];$.each(this.dictionary[wantedProp],function(index,value){$.each(query,function(iindex,vvalue){var score=_this.calcScore(vvalue,index,value.count,weight,wantedProp);if(score!==0){_this.addResult(value.keys,score);return true;}});});}};Searcher.prototype.addResult=function(keys,score){for(var i=keys.length- 1;i>=0;i--){if(this.results[keys[i]]===undefined){this.results[keys[i]]={key:keys[i],score:0};}
this.results[keys[i]].score+=score;}};Searcher.prototype.sortResults=function(){this.results=$.grep(this.results,function(n){return n;});this.results.sort(function(a,b){if(a.score<b.score){return 1;}
if(a.score>b.score){return-1;}
return 0;});};Searcher.prototype.calcScore=function(query,word,count,weight,prop){var score=word.indexOf(query);if(score===-1){return 0;}
var uniq;if(query===word){uniq=3;}else{uniq=Math.pow(query.length/word.length,2);}
return uniq*weight*(prop==='type'?this.avgCount:(1/count));};Searcher.prototype.fuzzySplit=function(query){var fuzzyQueries=[],splitWords=query.split(' ');for(var i=splitWords.length- 1;i>=0;i--){splitWord=splitWords[i];var wordQueries=[];if(splitWord.length>this.config.minChunkSize){for(var j=0;j<splitWord.length- this.config.minChunkSize+ 1;j++){for(var k=splitWord.length- j;k>=this.config.minChunkSize;k--){wordQueries.push(splitWord.substr(j,k));}}}else{wordQueries.push(splitWord);}
fuzzyQueries.push(wordQueries);}
return fuzzyQueries;}
Searcher.prototype.normalizeString=function(query){return $('<div>'+ query+'</div>').text().toLowerCase().replace(/[^A-z_]/g,' ').replace('\s+',' ').trim();};